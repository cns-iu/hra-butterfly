## Butterfly Visualization Workflow

This project generates a comprehensive butterfly visualization using ASCT+B and Blood Vasculature data. The workflow consists of two key Python scripts: `build-network.py` and `HRA_Butterfly_viz_v3.ipynb`, which together process the data and render the visualization.

### Workflow Overview
1. **Data Compilation**:
   - `build-network.py` fetches and processes the latest ASCT+B JSON data to construct the anatomical partonomy network and its related nodes and edges.
   - Outputs from this script are saved in CSV format for use in subsequent steps.
   - Configurable parameters:  
        - **Data version:** `VERSION`  
        - **Output path:** `OUTPUT_DIR`

2. **Visualization Generation**:
   - `HRA_Butterfly_viz_v3.ipynb` uses the outputs from `build-network.py` to generate the butterfly visualization. This includes creating organ-specific graphs, accurately representing vasculature connections between the heart and FTUs, and overlaying anatomical and vascular networks.
   - Additional required files:  
    - `Table_S1.csv`: Blood vasculature data  
    - `vega_config.json`: Vega radial layout configuration
  
   
### Detailed Scripts and their Roles

#### 1. `build-network.py`
This script constructs the base data required for butterfly visualization by fetching and processing the ASCT+B JSON data. It allows customization of the data version and output path through the `VERSION` and `OUTPUT_DIR` variables, respectively. The following steps outline its workflow:

1. **Fetch Data**: Retrieves the latest ASCT+B JSON data from the Human Reference Atlas (HRA) server.
2. **Node Creation**:
   - Generates unique IDs and labels for nodes representing anatomical structures (AS) and cell types (CT).
   - Includes metadata such as organ and ontology IDs.
3. **Edge Creation**:
   - Establishes relationships between nodes to form a tree-like network for each organ.
   - Ensures connectivity and correctness by adding missing edges for disconnected components.
4. **Output Generation**:
   - Saves the processed data into CSV files:
     - `asct-nodes.csv`: Contains details of nodes with columns for ID, name, type, organ, and ontology ID.
     - `asct-edges.csv`: Defines edges between nodes with columns for source, target, organ, and node types.
     - `asct-blood-vasculature-edges.csv`: Specifies edges for the blood vasculature network.

**Example Output (Nodes):**
| ID               | Name             | Type | Organ             | Ontology ID    |
|------------------|------------------|------|-------------------|----------------|
| UBERON:0013702   | Body             | AS   | Body              | UBERON:0013702 |
| UBERON:0000948   | Heart            | AS   | Blood Vasculature | UBERON:0000948 |

**Example Output (Edges):**
| Source           | Target           | Organ             | Source Type | Target Type |
|------------------|------------------|-------------------|-------------|-------------|
| UBERON:0013702   | UBERON:0000948   | Blood Vasculature | AS          | AS          |
| UBERON:0013702   | UBERON:0002113   | Kidney            | AS          | AS          |

#### 2. `HRA_Butterfly_viz_v3.ipynb`
This Jupyter notebook generates the final butterfly visualization using the CSV files generated by `build_network.py`. It also processes additional blood vasculature data from `Table_S1.csv`. The code is divided into the following sections:  

1. **Handling Libraries**:  
- Installs and imports all the necessary libraries.    
- Key libraries include: `numpy`, `pandas`, `networkx`, `matplotlib`, `datashader`, `vl-convert-python`, `svgutils`, and `lxml`.  

2. **Data Paths**:  
- Manages all file paths for data import and export.  
- Global variables defined:  
  - `nodes_url`: Path to `asct-nodes.csv`.  
  - `edges_url`: Path to `asct-edges.csv`.  
  - `ftu_vessel_url`: Path to `Table_S1.csv`.  
  - `output_path`: Defines where processed files are saved.  
  - `canvas_size`: Determines the size of the visualization canvas.  

3. **Algorithm and Visualization Logic**:  
This section is further subdivided to process nodes, edges, and generate hierarchical and vascular networks.  

- **3.1 Process Nodes and Edges:**  
    - Loads data from `asct-nodes.csv` and `asct-edges.csv`.  
    - Filters out irrelevant organs (e.g., `muscular_system`, `skeleton`, etc.).  
    - Defines organ display order for visualization.  

- **3.2 Edges Refinement:**  
    - Corrects edge connections, particularly for the respiratory nodes that directly connect to the body.  
    - Creates a `networkx` graph (`whole_graph`) for the anatomical structure.  

- **3.3 Nodes Refinement:**  
    - Generates a unique integer-based ID (`graph_int_id`) for each node to optimize graph traversal.  
    - Builds subgraphs for each organ by separating their nodes and edges. 
    - Ensures connectivity and structure within each organ graph.  

- **3.4 Data Quality Checks (Skippable):**  
    - Validates the integrity of nodes and edges.  
    - Identifies duplicates and disconnected components.  

- **3.5 Blood Vasculature Node Removal:**  
    - Removes redundant blood vasculature nodes to create the hierarchical structure.  
    - Generates `truncated_nodes` and `truncated_edges` for simplified visualization.

- **3.6 Statistics for Male and Female Graphs (Skippable):**  
    - Analyzes the number of FTUs, AS nodes, CT nodes, and structural edges for both male and female configurations.  

- **3.7 Construct Vega Visualization Configurations:**  
    - Uses the `truncated_nodes` and `truncated_edges` to generate Vega configuration files for visualization.  
    - Generates three Vega config files for each gender:  
        - `with_ids`: For hierarchical structuring.  
        - `with_names`: For labeled views.  
        - Standard view without labels.
    - Extracts node coordinates for both genders.   

- **3.8 Blood Vasculature Processing:**  
    - Reads `Table_S1.csv` to extract vasculature paths.
    - Map each FTU, its associated blood vessels and path elements to the ontology id in the ASCT-B data.
    - Construct vasculature edges using the PathStep as a guide. Negative PathStep indicates arteries, positive PathStep indicates veins.
    - Map IDs from source and target columns using id_to_graph_int_id; assign coordinates from coordinates_of_nodes_fem and coordinates_of_nodes_male.
    - Constructs arterial and venous edges for the visualization for both male and female.  

Format of `Table_S1.csv` the file:

|   |              FTU |          FTUID |             Vessel | VesselID | PathStep |                    PathVessel |   PathVesselID |
|--:|-----------------:|---------------:|-------------------:|---------:|---------:|------------------------------:|---------------:|
| 0 | alveolus of lung | UBERON:0002299 | alveolar capillary |          |       -8 |               right ventricle | UBERON:0002080 |
| 1 | alveolus of lung | UBERON:0002299 | alveolar capillary |          |       -7 |               pulmonary trunk | UBERON:0002333 |
| 2 | alveolus of lung | UBERON:0002299 | alveolar capillary |          |       -6 |         left pulmonary artery | UBERON:0001652 |
| 3 | alveolus of lung | UBERON:0002299 | alveolar capillary |          |       -5 |    segmental pulmonary artery |       FMA:8755 |
| 4 | alveolus of lung | UBERON:0002299 | alveolar capillary |          |       -4 | subsegmental pulmonary artery |       FMA:9311 |


- **3.9 Plot Blood Vessels:**  
    - Creates separate subgraphs for arteries and veins.  
    - Fixes node positions for nodes present in the `trucnated_nodes` dataframe; other node positions are rendered using spring layout. 
    - Applies Hammer bundling to group and curve edges for improved clarity.
    - Plots the bundled edges on a canvas matching Vega configuration size. 
    - Final vascular graph is rendered onto the radial layout and saved as an SVG file.

4. **Final Layout**:  
- Combines the anatomical hierarchy and blood vasculature layers for both male and female wings.  
- Flips text horizontally for female wing (or male wing, depending on use case), to preserve readability in mirrored view.  

5. **Adobe Illustrator Integration**: 
- Provides guidance for using Adobe Illustrator to overlay male and female wings and finalize the butterfly visualization.  
- SVG outputs from Section 4 are imported and enhanced for publication-quality results.  

### Input and Output Data 

#### Input Files:  
| File Name              | Description                               |
|------------------------|-------------------------------------------|
| `asct-nodes.csv`       | Node data for anatomical structures       |
| `asct-edges.csv`       | Edge data for anatomical connections      |
| `Table_S1.csv`         | Blood vasculature data                    |
| `vega_config.json`     | Vega configuration for radial layout      |

#### Output Files:  
| File Name                            | Description                                    |
|--------------------------------------|------------------------------------------------|
| `viz_v2.0/male_butterfly_wing.svg`   | Male anatomical and vascular visualization     |
| `viz_v2.0/female_butterfly_wing.svg` | Female anatomical and vascular visualization   |
| `viz_v2.0/blood_viz_male.pdf`        | Male blood vasculature overlay visualization   |
| `viz_v2.0/blood_viz_female.pdf`      | Female blood vasculature overlay visualization |


### Instructions for Running
1. **Set Up the Environment**:
   Run the `setup.sh` script to create and configure the Conda environment:
   ```bash
   ./setup.sh
   ```
   The script performs the following tasks:
   - Creates a Conda environment named `butterfly`.
   - Installs Python 3.11 and necessary dependencies.
   - Activates the `butterfly` environment.

2. **Run `build-network.py`**:
   ```bash
   python build-network.py
   ```
   - This script processes the data and generates CSV files in the `data/` directory.

3. **Download `Table_S1.csv`**:
   Download the vascular network data file from [Zenodo](https://zenodo.org/records/11477239) and place it in the `data/` directory.

4. **Run `HRA_Butterfly_viz_v3.ipynb`**:
   ```bash
   jupyter notebook HRA_Butterfly_viz_v3.ipynb
   ```
   - Outputs will be saved in the `viz_v2.0/` directory.

### Notes
- Both scripts require Python 3.11 or higher.
- Install dependencies using the `setup.sh` script.
- The generated visualization can be further refined using Adobe Illustrator or similar tools.

### Additional Details
- For more information, refer to the [HRA ASCT+B Reporter](https://humanatlas.io/asctb-reporter).
- Contact the project maintainers for assistance with data or scripts.
